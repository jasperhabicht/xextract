% File: xextract.sty
% Copyright 2025-2026 Jasper Habicht (mail(at)jasperhabicht.de).
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License version 1.3c,
% available at http://www.latex-project.org/lppl/.
%
% This file is part of the `xextract' package (The Work in LPPL)
% and all files in that bundle must be distributed together.
%
% This work has the LPPL maintenance status `maintained'.
%
\ProvidesExplPackage {xextract} {2026-02-20} {0.2}
    {A completely rewritten L3 implementation of the extract package.}

\bool_new:N \l__xextract_active_bool
\clist_new:N \l__xextract_extract_env_clist
\clist_new:N \l__xextract_extract_labels_clist
\iow_new:N \l__xextract_iow
\str_new:N \l__xextract_file_str
\tl_new:N \g__xextract_label_tl
\tl_new:N \l__xextract_extract_tl

% create most important keys
\keys_define:nn { xextract } {
    active          .bool_set:N  = \l__xextract_active_bool ,
    active          .default:n   = { true } ,
    active          .initial:n   = { false } ,
    generate        .str_set:N   = \l__xextract_file_str ,
    generate        .initial:n   = { file } ,
    extract-env     .code:n      = {
        \clist_set:Nn \l__xextract_extract_env_clist {#1}
        \clist_map_inline:nn {#1} {
            \clist_new:c { l__xextract_ ##1 _labels_clist }
            \keys_define:nn { l3extract } {
                ##1 -labels  .clist_set:c = { l__xextract_ ##1 _labels_clist }
            }
        }
    },
    extract-env     .initial:n   = { verbatim } ,
    extract-labels  .clist_set:N = \l__xextract_extract_labels_clist ,
}

\ProcessKeyOptions [ xextract ]

% write environment to external fllw
\cs_new_protected:Npn \__xextract_extract_env_aux:nn #1#2 {
    \group_begin:
        \tl_set:Nn \l__xextract_extract_tl {#2}
        \tl_replace_all:Nen \l__xextract_extract_tl {
            \char_generate:nn { 13 } { 13 }
        } { \iow_newline: }
        \tl_put_left:Nn \l__xextract_extract_tl {
            \tl_to_str:n { \begin {#1} }
        }
        \tl_put_right:Nn \l__xextract_extract_tl {
            \tl_to_str:n { \end {#1} }
        }
        \exp_args:NNNe
    \group_end:
    \iow_now:Nn \l__xextract_iow \l__xextract_extract_tl
}

% decide whether to extract environmwnr
\cs_new_protected:Npn \__xextract_extract_env:nn #1#2 {
    \bool_lazy_and:nnTF {
        \clist_if_exist_p:c { l__xextract_ #1 _labels_clist }
    } {
        \bool_not_p:n {
            \clist_if_empty_p:c { l__xextract_ #1 _labels_clist }
        }
    } {
        \clist_if_in:cVT { l__xextract_ #1 _labels_clist }
            \g__xextract_label_tl { 
                \__xextract_extract_env_aux:nn {#1} {#2}
            }
    } {
        \__xextract_extract_env_aux:nn {#1} {#2}
    }
}

% construct \end{verbatim} with verbatim catcodes
\tl_const:Ne \c__xextract_verbatim_end_tl {
    \c_backslash_str end \c_left_brace_str verbatim \c_right_brace_str
}

% replacement for verbatim environment
\exp_last_unbraced:NNNNo
    \cs_new_protected:Npn \__xextract_verbatim:w #1 \c__xextract_verbatim_end_tl {
        #1
        \end { verbatim }
        \__xextract_extract_env:nn { verbatim } {#1}
        \tl_gclear:N \g__xextract_label_tl
    }

% better approach would probably to use hooks, but this does not work easily
% another approach could be to always grab the environment verbatim (this is how the original package solves this)
\cs_new_protected:Npn \__xextract_collect_env:n #1 {
    \cs_set_eq:cc { __xextract_ #1 _copy_begin: } {#1}
    \cs_set_eq:cc { __xextract_ #1 _copy_end: } { end #1 }

    \tl_if_eq:nnTF {#1} { verbatim } {
        \cs_set_eq:NN \@xverbatim \__xextract_verbatim:w
    } {
        \RenewDocumentEnvironment {#1} { +b } {
            \__xextract_extract_env:nn {#1} {##1}
            \use:c { __xextract_ #1 _copy_begin: }
            ##1
            \use:c { __xextract_ #1 _copy_end: }
        } { 
            \tl_gclear:N \g__xextract_label_tl
        }
    }
}

\bool_if:NT \l__xextract_active_bool {
    \clist_map_inline:Nn \l__xextract_extract_env_clist {
        \__xextract_collect_env:n {#1}
    }
    \iow_open:Nn \l__xextract_iow { 
        \l__xextract_file_str .tex 
    }
    \AddToHook { enddocument } {
        \iow_close:N \l__xextract_iow
    }
}

\NewDocumentEnvironment { extract } { o +b } {
    \bool_if:NTF \l__xextract_active_bool {
        \IfValueTF {#1} {
            \clist_if_in:NnT \l__xextract_extract_labels_clist {#1} {
                \iow_now:Nn \l__xextract_iow {#2}
            }
        } {
            \iow_now:Nn \l__xextract_iow {#2}
        }
    } {
        #2
    }
} { }

\NewDocumentEnvironment { extract* } { +b } {
    \bool_if:NT \l__xextract_active_bool {
        \iow_now:Nn \l__xextract_iow {#1}
    }
    #1
} { }

\NewDocumentCommand { \extractionlabel } { m } {
    \tl_gset:Nn \g__xextract_label_tl {#1}
}

% EOF